<!-- <!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>ì˜ˆì¸¡ ê²°ê³¼</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="/static/style.css" />
    <script src="/static/js/script.js" defer></script>
  </head>
  <body>
    <div class="result-container" style="padding: 20px; text-align: center">
      <h2>ì˜ˆì¸¡ ê²°ê³¼ ì¡°íšŒ</h2>

      <div class="dateSelect" style="margin-bottom: 20px">
        <h3>ë‚ ì§œ ì„ íƒ</h3>
        <input
          type="text"
          id="resultDateRange"
          placeholder="ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”"
          style="padding: 8px"
        />
        <button id="downloadCsvBtn" style="margin-left: 10px">
          CSV ë‹¤ìš´ë¡œë“œ
        </button>
      </div>

      <div class="yield-display" style="margin-bottom: 20px; font-size: 1.2em">
        ì„ íƒí•œ ë‚ ì§œ [<span id="resultDate" style="font-weight: bold"></span>]ì˜
        ì´ ì˜ˆì¸¡ ë°œì „ëŸ‰:
        <span id="totalYield" style="font-weight: bold; color: #4a90e2"></span>
      </div>

      <div class="chart-container" style="width: 80%; margin: auto">
        <canvas id="resultChart"></canvas>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <p>Â© 2025 Check on Solar Power. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html> -->

<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>DashBoard</title>

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (CSS & JS) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ëŒ€ì‹œë³´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ì‹œíŠ¸ -->
    <link rel="stylesheet" href="/static/DashBoardStyle.css" />
  </head>
  <body>
    <div class="topBoard">
      <div class="background">
        <div class="top-row">
          <!-- ì˜ˆì¸¡ ì§€ì—­ -->
          <div class="left1">
            <div class="title1">ì˜ˆì¸¡ ì§€ì—­</div>
            <div class="cotent1">
              <div class="c11" id="regionDisplay">ì§€ì—­ ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <!-- ì˜ˆì¸¡ ë‚ ì§œ ì„ íƒ -->
          <div class="left2">
            <div class="title2">ì˜ˆì¸¡ ë‚ ì§œ</div>
            <div class="content2">
              <input
                type="text"
                id="resultDateRange"
                placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”"
              />
            </div>
          </div>

          <!-- ì˜ˆì¸¡ëŸ‰ ìš”ì•½ -->
          <div class="left3">
            <div class="title3">ê¸°ê°„ í‰ê·  ì˜ˆì¸¡ëŸ‰</div>
            <div class="content3">
              <div class="c31" id="avgYield">0.00 kWh</div>
            </div>
          </div>

          <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
          <div class="left4">
            <button id="downloadCsvBtn">.scv <br />ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>

        <div class="second-row">
          <!-- ê·¸ë˜í”„ 1 -->
          <div class="graph1">
            <div class="title5">ì¼ë³„ ì˜ˆì¸¡ ë°œì „ëŸ‰ (Daily Yield)</div>
            <div
              id="selectedDateDisplay"
              style="margin-bottom: 10px; font-weight: bold; color: #333"
            >
              -
            </div>
            <div class="subject1">
              <canvas id="resultChart" width="400" height="300"></canvas>
            </div>
          </div>
        </div>

        <div class="third-row">
          <div class="third-title">ì„ íƒ ë‚ ì§œ ì´ ë°œì „ëŸ‰</div>
          <div class="third-content" id="totalYield">0.00 kWh</div>
        </div>
      </div>
    </div>

    <!-- âœ¨ ì¤‘ìš”: ê¸°ì¡´ script.jsì˜ ëª¨ë“  ê¸°ëŠ¥ì´ ì´ ì•ˆì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤. -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- 1. í•„ìš”í•œ ë³€ìˆ˜ ë° ë§¤í•‘ ì •ë³´ ì„¤ì • ---
        let chartInstance = null;
        const plantId = sessionStorage.getItem("selectedPlantId");

        const idToRegionMapping = {
          4135001: "ê´‘ì£¼ê´‘ì—­ì‹œ ë¶êµ¬ ìš©ë´‰ë™",
          4136001: "ì „ë¼ë¶ë„ ë‚¨ì›ì‹œ ì£¼ì²œë©´ ìš©ë‹´ë¦¬",
        };

        // --- 2. í˜ì´ì§€ ì´ˆê¸°í™” ---
        if (!plantId) {
          alert("ì„ íƒëœ ì§€ì—­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
          window.location.href = "/";
          return;
        }

        const regionName = idToRegionMapping[plantId] || "ì•Œ ìˆ˜ ì—†ëŠ” ì§€ì—­";
        document.getElementById("regionDisplay").textContent = regionName;

        // --- 3. ë‚ ì§œ ì„ íƒê¸°(flatpickr) ì„¤ì • ---
        const datePicker = flatpickr("#resultDateRange", {
          defaultDate: "today",
          // í˜ì´ì§€ê°€ ì¤€ë¹„ë˜ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì°¨íŠ¸ë¥¼ ë°”ë¡œ ê·¸ë¦½ë‹ˆë‹¤.
          onReady: function (selectedDates, dateStr, instance) {
            fetchAndDrawChart(instance.input.value);
          },
          // ë‚ ì§œë¥¼ ìƒˆë¡œ ì„ íƒí•˜ë©´ ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
          onClose: function (selectedDates, dateStr, instance) {
            fetchAndDrawChart(dateStr);
          },
        });

        // --- 4. í•µì‹¬ í•¨ìˆ˜: API í˜¸ì¶œ ë° í™”ë©´ ì—…ë°ì´íŠ¸ ---
        async function fetchAndDrawChart(date) {
          if (!date) return;
          const url = `/get_predictions?plant_id=${plantId}&date=${date}`;

          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            const data = await response.json();

            // ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸°
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD í˜•ì‹

            // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
            document.getElementById(
              "selectedDateDisplay"
            ).textContent = `ì„ íƒí•œ ê¸°ê°„: ${today} ~ ${date}`;

            // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ 1: IDì— ë§ê²Œ ê°ê°ì˜ ìœ„ì¹˜ì— ë°ì´í„°ë¥¼ í‘œì‹œ ---
            const totalYield =
              data.predicted_yield_for_requested_date.toFixed(2);
            const chartValues = data.chart_data.map((r) => r.yield);
            const averageYield =
              chartValues.length > 0
                ? (
                    chartValues.reduce((a, b) => a + b, 0) / chartValues.length
                  ).toFixed(2)
                : "0.00";

            document.getElementById(
              "totalYield"
            ).textContent = `${totalYield} kWh`;
            document.getElementById(
              "avgYield"
            ).textContent = `${averageYield} kWh`;

            // [ì°¨íŠ¸ ê·¸ë¦¬ê¸°]
            if (chartInstance) {
              chartInstance.destroy();
            }
            const ctx = document.getElementById("resultChart").getContext("2d");
            chartInstance = new Chart(ctx, {
              type: "line",
              data: {
                labels: data.chart_data.map((r) => r.date),
                datasets: [
                  {
                    label: "ì¼ë³„ ì˜ˆì¸¡ ë°œì „ëŸ‰ (Daily Yield)",
                    data: chartValues,
                    borderColor: "rgba(153, 102, 255, 1)",
                    backgroundColor: "rgba(153, 102, 255, 0.2)",
                    fill: true,
                    tension: 0.4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
              },
            });

            // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ 2: ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ IDë¥¼ ì¼ì¹˜ì‹œí‚¤ê³  ì´ë²¤íŠ¸ ì—°ê²° ---
            const downloadBtn = document.getElementById("downloadCsvBtn");
            // ê¸°ì¡´ì— ì—°ê²°ëœ ì´ë²¤íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const newBtn = downloadBtn.cloneNode(true);
            downloadBtn.parentNode.replaceChild(newBtn, downloadBtn);
            // ìƒˆ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            newBtn.addEventListener("click", function () {
              downloadAsCsv(
                data.chart_data,
                `prediction_${plantId}_${date}.csv`
              );
            });
          } catch (err) {
            console.error("ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
            document.getElementById(
              "resultChart"
            ).parentElement.innerHTML = `<p style="color: red; text-align: center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
          }
        }

        // --- 5. CSV ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜ ---
        function downloadAsCsv(data, filename) {
          if (!data || data.length === 0) {
            alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          const headers = Object.keys(data[0]);
          const csvContent = [
            headers.join(","),
            ...data.map((row) =>
              headers.map((header) => row[header]).join(",")
            ),
          ].join("\n");

          const blob = new Blob([`\uFEFF${csvContent}`], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      });
    </script>
  </body>
</html>
